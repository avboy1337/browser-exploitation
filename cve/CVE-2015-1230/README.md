UserAgent: Mozilla/5.0 (Windows NT 6.3; WOW64; Trident/7.0; .NET4.0E; .NET4.0C; Tablet PC 2.0; rv:11.0) like Gecko

Steps to reproduce the problem:
ZDI-CAN-2662: Google Chrome V8EventListenerList::findOrCreateWrapper Type Confusion Remote Code Execution Vulnerability

-- CVSS -----------------------------------------

6.8, AV:N/AC:M/Au:N/C:P/I:P/A:P

-- ABSTRACT -------------------------------------

HP's Zero Day Initiative has identified a vulnerability affecting the following products:

  Google Chrome

-- VULNERABILITY DETAILS ------------------------

Tested on win8.1/Chrome 41.0.2249.0

```

The problem starts from here:

template<typename WrapperType>
PassRefPtr<V8EventListener> V8EventListenerList::findOrCreateWrapper(v8::Local<v8::Value> value, bool isAttribute, ScriptState* scriptState)
{
v8::Isolate* isolate = scriptState->isolate();
ASSERT(isolate->InContext());
if (!value->IsObject()
// Non-callable attribute setter input is treated as null (no wrapper)
|| (isAttribute &amp;&amp; !value->IsFunction()))
return nullptr;

v8::Local<v8::Object> object = v8::Local<v8::Object>::Cast(value);
v8::Handle<v8::String> wrapperProperty = getHiddenProperty(isAttribute, isolate);

V8EventListener* wrapper = doFindWrapper(object, wrapperProperty, scriptState);
if (wrapper)
return wrapper;

RefPtr<V8EventListener> wrapperPtr = WrapperType::create(object, isAttribute, scriptState);
if (wrapperPtr)
object->SetHiddenValue(wrapperProperty, v8::External::New(isolate, wrapperPtr.get()));

return wrapperPtr;
}

Then:

static V8EventListener* doFindWrapper(v8::Local<v8::Object> object, v8::Handle<v8::String> wrapperProperty, ScriptState* scriptState)
{
v8::HandleScope scope(scriptState->isolate());
ASSERT(scriptState->isolate()->InContext());
v8::Local<v8::Value> listener = object->GetHiddenValue(wrapperProperty);
if (listener.IsEmpty())
return 0;
return static_cast<V8EventListener*>(v8::External::Cast(*listener)->Value());
}

The listener will contain a pointer to AudioListener rather than V8EventListener, which results in a bad cast.

(754.ea0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=11fb6d00 ebx=0014ec60 ecx=00000001 edx=00000001 esi=0014ed88 edi=03e872b4
eip=5c42876a esp=0014ebfc ebp=0014ec2c iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Users\ZDI\AppData\Local\Google\Chrome SxS\Application\41.0.2231.0\chrome_child.dll - 
chrome_child!ovly_debug_event+0x217f60:
5c42876a ff4004          inc     dword ptr [eax+4]    ds:0023:11fb6d04=????????
5:058> dd eax
11fb6d00  ???????? ???????? ???????? ????????
11fb6d10  ???????? ???????? ???????? ????????
11fb6d20  ???????? ???????? ???????? ????????
11fb6d30  ???????? ???????? ???????? ????????
11fb6d40  ???????? ???????? ???????? ????????
11fb6d50  ???????? ???????? ???????? ????????
11fb6d60  ???????? ???????? ???????? ????????
11fb6d70  ???????? ???????? ???????? ????????
5:058> g
ModLoad: 68300000 6830a000   C:\Windows\SYSTEM32\LINKINFO.dll
(754.ea0): Access violation - code c0000005 (!!! second chance !!!)
eax=11fb6d00 ebx=0014ec60 ecx=00000001 edx=00000001 esi=0014ed88 edi=03e872b4
eip=5c42876a esp=0014ebfc ebp=0014ec2c iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
chrome_child!ovly_debug_event+0x217f60:
5c42876a ff4004          inc     dword ptr [eax+4]    ds:0023:11fb6d04=????????
5:058> g
ModLoad: 75060000 75072000   C:\Windows\system32\imagehlp.dll
ModLoad: 66d80000 66e20000   C:\Windows\system32\ntshrui.dll
(754.ea0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=11fb6d00 ebx=0014ec60 ecx=00000001 edx=00000001 esi=0014ed88 edi=03e872b4
eip=5c42876a esp=0014ebfc ebp=0014ec2c iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
chrome_child!ovly_debug_event+0x217f60:
5c42876a ff4004          inc     dword ptr [eax+4]    ds:0023:11fb6d04=????????
5:058> u
chrome_child!ovly_debug_event+0x217f60:
5c42876a ff4004          inc     dword ptr [eax+4]
5c42876d 8903            mov     dword ptr [ebx],eax
5c42876f 8bc3            mov     eax,ebx
5c428771 5f              pop     edi
5c428772 5e              pop     esi
5c428773 5b              pop     ebx
5c428774 8be5            mov     esp,ebp
5c428776 5d              pop     ebp
5:058> kvb
ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
0014ec2c 5c428675 0014ed88 3ab87f40 0014eccc chrome_child!ovly_debug_event+0x217f60
0014ec48 5c428362 0014eca4 3ab87f40 0014ed88 chrome_child!ovly_debug_event+0x217e6b
0014ecac 5c4281d5 0014ece8 5c3be288 0014eccc chrome_child!ovly_debug_event+0x217b58
0014ecb4 5c3be288 0014eccc 03fb00e8 5c4281bf chrome_child!ovly_debug_event+0x2179cb
0014ece8 5c3be100 0014ed10 5c4281bf 00000004 chrome_child!ovly_debug_event+0x1ada7e
0014ed50 5c3bdf4a 00000004 0014ed90 0014ed7c chrome_child!ovly_debug_event+0x1ad8f6
0014edfc 5c3398da 16856ee0 2413396d 3ef81d2d chrome_child!ovly_debug_event+0x1ad740
0014ee48 5c339757 03e8728c 03e87294 00000000 chrome_child!ovly_debug_event+0x1290d0
0014ee84 5c405e1d 03e8728c 03e87294 00000000 chrome_child!ovly_debug_event+0x128f4d
0014eecc 5c40e04a 0014eef4 00000000 03e8728c chrome_child!ovly_debug_event+0x1f5613
0014ef18 5c40aa5e 03e8728c 3f20406c 3aa88000 chrome_child!ovly_debug_event+0x1fd840

7:070> lmvm chrome
start    end        module name
00a60000 00b37000   chrome     (deferred)             
    Image path: chrome.exe
    Image name: chrome.exe
    Timestamp:        Sat Dec 13 07:32:04 2014 (548C5BF4)
    CheckSum:         000D4A13
    ImageSize:        000D7000
    File version:     41.0.2249.0
    Product version:  41.0.2249.0
    File flags:       0 (Mask 17)
    File OS:          4 Unknown Win32
    File type:        1.0 App
    File date:        00000000.00000000
    Translations:     0409.04b0
    CompanyName:      Google Inc.
    ProductName:      Google Chrome
    InternalName:     chrome_exe
    OriginalFilename: chrome.exe
    ProductVersion:   41.0.2249.0
    FileVersion:      41.0.2249.0
    FileDescription:  Google Chrome
    LegalCopyright:   Copyright 2012 Google Inc. All rights reserved.
7:070> vertarget
Windows 7 Version 9200 UP Free x86 compatible
Product: WinNt, suite: SingleUserTS
kernel32.dll version: 6.3.9600.17031 (winblue_gdr.140221-1952)
Machine Name:
Debug session time: Mon Dec 15 07:13:21.050 2014 (GMT-8)
System Uptime: 3 days 11:00:01.235
Process Uptime: 0 days 0:00:36.334
  Kernel time: 0 days 0:00:00.031
  User time: 0 days 0:00:00.703

```

-- CREDIT ---------------------------------------

This vulnerability was discovered by:

   SkyLined working with HP's Zero Day Initiative

-- FURTHER DETAILS ------------------------------

If supporting files were contained with this report they are provided within a password protected ZIP file. The password is the ZDI candidate number in the form: ZDI-CAN-XXXX where XXXX is the ID number.

Please confirm receipt of this report. We expect all vendors to remediate ZDI vulnerabilities within 120 days of the reported date. If you are ready to release a patch at any point leading up the the deadline please coordinate with us so that we may release our advisory detailing the issue. If the 120 day deadline is reached and no patch has been made available we will release a limited public advisory with our own mitigations so that the public can protect themselves in the absence of a patch. Please keep us updated regarding the status of this issue and feel free to contact us at any time:

Zero Day Initiative
zdi-disclosures@hp.com

The PGP key used for all ZDI vendor communications is available from:

     http://www.zerodayinitiative.com/documents/zdi-pgp-key.asc

-- INFORMATION ABOUT THE ZDI ---------------------

Established by TippingPoint and acquired by Hewlett-Packard, The Zero Day Initiative (ZDI) represents a best-of-breed model for rewarding security researchers for responsibly disclosing discovered vulnerabilities.

The ZDI is unique in how the acquired vulnerability information is used. The ZDI does not re-sell the vulnerability details or any exploit code. Instead, upon notifying the affected product vendor, the ZDI provides its HP TippingPoint customers with zero day protection through its intrusion prevention technology. Explicit details regarding the specifics of the vulnerability are not exposed to any parties until an official vendor patch is publicly available.

    http://www.zerodayinitiative.com

-- DISCLOSURE POLICY ----------------------------

Our vulnerability disclosure policy is available online at:

    http://www.zerodayinitiative.com/advisories/disclosure_policy/

What is the expected behavior?

What went wrong?
The full report is above.

Did this work before? N/A 

Chrome version: Chrome 41.0.2249.0  Channel: n/a
OS Version: 8.1
Flash Version: 

Predicted Disclosure:	05/16/2015