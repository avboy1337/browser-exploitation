<b>VULNERABILITY DETAILS</b>

There is an unchecked allocation in V8 ValueDeserializer::ReadJSArrayBuffer()
that can cause a heap buffer overflow.
In case of OOM JSArrayBuffer::SetupAllocationData() doesn't change the
backing_store in JSArrayBuffer and returns false. This return value is not
checked and the buffer is assumed to be of the new length at the next memcpy() call.

It seems to me that backing_store is somehow reused from a previous array,
it points to a writable memory area but with smaller length.

I have attached a simple patch that should fix this vulnerability.

The bug was introduced in V8 with https://codereview.chromium.org/2264403004
This has been merged into Chromium with https://codereview.chromium.org/2283283002
Chromium versions from 55.0.2842.0 are affected.

<b>VERSION</b>

Chrome Version: Bug was introduced in 55.0.2842.0
Operating System: Reproducible on Linux x64 but all OSes are affected

<b>REPRODUCTION CASE</b>

On Linux x64 the attached files can reproduce this crash with a high probability on
current Canary builds (commit 94af7a6d022fc5368503a8c47480d012617376f3)
and with a smaller probability (about 10%) on current stable version
(Version 55.0.2883.87 (64-bit) on Linux x64).

Sorry for the large asmcrypto.js file in the repro case, but without it
the probability of triggering this bug is much smaller. Most of the cases
the tab crashes properly with CRASH_OOM() in the main thread instead of the
worker.
That file was downloaded from an official asmcrypto download page:
http://vibornoff.com/asmcrypto.js

<b>FOR CRASHES, PLEASE INCLUDE THE FOLLOWING ADDITIONAL INFORMATION</b>

Type of crash: tab
Crash State:

Thread 11 "DedicatedWorker" received signal SIGSEGV, Segmentation fault.
[-------------------------------------------------------------registers--------------------------------------------------------------]
RAX: 0x33b5f9182311 --> 0x0                
RBX: 0x1e8000                              
RCX: 0x187791                              
RDX: 0x1e8480                              
RSI: 0x1d573e264cf5 --> 0x0                
RDI: 0x33b5f91e3000 --> 0x0                
RBP: 0xe242a437fa8 --> 0xe242a790000 --> 0xe2429c3c1e0 (0x00000e242a790000)
RSP: 0x7fb6a3ec3438 --> 0x55fd11a3bc18 (<_ZN2v88internal17ValueDeserializer17ReadJSArrayBufferEv+184>:  add    QWORD PTR [rbp+0x10],r1
2)                                         
RIP: 0x7fb6b2d0ba96 (<__memmove_avx_unaligned+710>:     rep movs BYTE PTR es:[rdi],BYTE PTR ds:[rsi])
R8 : 0xffffffff                            
R9 : 0x0                                   
R10: 0x22 (")                              
R11: 0x246                                 
R12: 0x1e8480                              
R13: 0xe2429d451b0 --> 0x34bcaeff7d59 --> 0x41000038256c1064
R14: 0x7fb6a3ec34a8 --> 0x55fd143a6ead (<_ZN5blink11ScriptState4fromEN2v85LocalINS1_7ContextEEE+109>:   test   rax,rax)
R15: 0x0                                   
[----------------------------------------------------------------code----------------------------------------------------------------]
   0x7fb6b2d0ba8e <__memmove_avx_unaligned+702>:        jae    0x7fb6b2d0baa0 <__memmove_avx_unaligned+720>
   0x7fb6b2d0ba90 <__memmove_avx_unaligned+704>:        mov    rcx,rdx
   0x7fb6b2d0ba93 <__memmove_avx_unaligned+707>:        mov    rcx,rdx
=> 0x7fb6b2d0ba96 <__memmove_avx_unaligned+710>:        rep movs BYTE PTR es:[rdi],BYTE PTR ds:[rsi]
   0x7fb6b2d0ba98 <__memmove_avx_unaligned+712>:        ret 
   0x7fb6b2d0ba99 <__memmove_avx_unaligned+713>:        nop    DWORD PTR [rax+0x0]
   0x7fb6b2d0baa0 <__memmove_avx_unaligned+720>:        lea    rcx,[rsi+rdx*1]
   0x7fb6b2d0baa4 <__memmove_avx_unaligned+724>:        vmovdqu ymm4,YMMWORD PTR [rsi]
[---------------------------------------------------------------stack----------------------------------------------------------------]
00:0000| rsp 0x7fb6a3ec3438 --> 0x55fd11a3bc18 (<_ZN2v88internal17ValueDeserializer17ReadJSArrayBufferEv+184>:  add    QWORD PTR [rbp+0x10],r12)                                                  
01:0008|     0x7fb6a3ec3440 --> 0x42 (B)                    
02:0016|     0x7fb6a3ec3448 --> 0x1d573e204003 --> 0x7a8980 
03:0024|     0x7fb6a3ec3450 --> 0x7fb6a3ec3558 --> 0x0      
04:0032|     0x7fb6a3ec3458 --> 0xea6efb0e080 --> 0x50e3b0ef00000003
05:0040|     0x7fb6a3ec3460 --> 0x7fb6a3ec3558 --> 0x0      
06:0048|     0x7fb6a3ec3468 --> 0x7fb6a3ec36f8 --> 0xe242a437fa0 --> 0xe242a790000 --> 0xe2429c3c1e0 (0x00000e242a790000)
07:0056|     0x7fb6a3ec3470 --> 0x33b5f9182351 --> 0x0      
[------------------------------------------------------------------------------------------------------------------------------------]
Legend: stack, code, data, heap, rodata, value              
Stopped reason: SIGSEGV                                     
0x00007fb6b2d0ba96 in __memmove_avx_unaligned () from /lib64/libc.so.6

gdb-peda$ bt                                                
#0  0x00007fb6b2d0ba96 in __memmove_avx_unaligned () from /lib64/libc.so.6
#1  0x000055fd11a3bc18 in v8::internal::ValueDeserializer::ReadJSArrayBuffer() ()
#2  0x000055fd11a39ba0 in v8::internal::ValueDeserializer::ReadObjectInternal() ()
#3  0x000055fd11a399c3 in v8::internal::ValueDeserializer::ReadObject() ()
#4  0x000055fd113aa07f in v8::ValueDeserializer::ReadValue(v8::Local<v8::Context>) ()
#5  0x000055fd14438e93 in blink::V8ScriptValueDeserializer::deserialize() ()
#6  0x000055fd14d9380e in blink::SerializedScriptValueForModulesFactory::deserialize(blink::SerializedScriptValue*, v8::Isolate*, blink::HeapVector<blink::Member<blink::MessagePort>, 0ul>*, WTF::Vector<blink::WebBlobInfo, 0ul, WTF::PartitionAllocator> const*) ()
#7  0x000055fd15f6e7ea in blink::V8MessageEvent::dataAttributeGetterCustom(v8::FunctionCallbackInfo<v8::Value> const&) ()
#8  0x000020656f0307cb in ?? ()            
#9  0x00007fb6a3ec3848 in ?? ()            
#10 0x00007fb6a3ec3880 in ?? ()            
#11 0x0000000000000000 in ?? () 

gdb-peda$ vmmap $rdi
Start              End                Perm      Name
0x000033b5f91e3000 0x000033b5f9200000 ---p      mapped

gdb-peda$ vmmap $rdi-1
Start              End                Perm      Name
0x000033b5f9180000 0x000033b5f91e3000 rw-p      mapped
